import { describe, it, expect, vi, beforeEach } from 'vitest';
import { handleGetDuplicationSummary } from './duplication-summary.handler';

// Mock all dependencies
vi.mock('../../core/analysis/index.js');
vi.mock('../../universal/project-manager');
vi.mock('../../shared/validators/mcp-schemas');

describe('handleGetDuplicationSummary', () => {
  let mockQualityAnalyzer: any;
  let mockProjectManager: any;
  let mockValidateInput: any;

  beforeEach(async () => {
    // Mock validateInput
    const validators = await import('../../shared/validators/mcp-schemas');
    mockValidateInput = vi.mocked(validators.validateInput);
    mockValidateInput.mockReturnValue({
      sortBy: 'duplicatedLines',
      maxResults: 50,
      pageSize: 100
    });

    // Mock ProjectManager
    const projectManagerModule = await import('../../universal/project-manager');
    mockProjectManager = {};
    vi.mocked(projectManagerModule.ProjectManager).mockImplementation(() => mockProjectManager);

    // Mock QualityAnalyzer
    const analysisModule = await import('../../core/analysis/index.js');
    mockQualityAnalyzer = {
      getDuplicationSummary: vi.fn(async () =>
        'DUPLICATION SUMMARY\n\nTotal duplicated files: 5\nTotal duplicated lines: 150'
      )
    };
    vi.mocked(analysisModule.QualityAnalyzer).mockImplementation(() => mockQualityAnalyzer);
  });

  describe('Success cases', () => {
    it('should validate input and call QualityAnalyzer', async () => {
      const args = {
        sortBy: 'duplicatedLines',
        maxResults: 50,
        pageSize: 100
      };

      const result = await handleGetDuplicationSummary(args);

      expect(mockValidateInput).toHaveBeenCalledWith(
        expect.anything(),
        args,
        'sonar_get_duplication_summary'
      );
      expect(mockQualityAnalyzer.getDuplicationSummary).toHaveBeenCalledWith(
        {
          sortBy: 'duplicatedLines',
          maxResults: 50,
          pageSize: 100
        },
        undefined
      );
      expect(result).toHaveProperty('content');
      expect(result.content[0].type).toBe('text');
    });

    it('should pass correlation ID through', async () => {
      const correlationId = 'test-corr-123';
      await handleGetDuplicationSummary({}, correlationId);

      expect(mockQualityAnalyzer.getDuplicationSummary).toHaveBeenCalledWith(
        expect.anything(),
        correlationId
      );
    });

    it('should return duplication summary report', async () => {
      const result = await handleGetDuplicationSummary({});

      expect(result.content[0].text).toContain('DUPLICATION SUMMARY');
      expect(result.content[0].text).toContain('Total duplicated');
    });

    it('should handle different sort options', async () => {
      mockValidateInput.mockReturnValue({
        sortBy: 'duplicatedBlocks',
        maxResults: 10,
        pageSize: 50
      });

      await handleGetDuplicationSummary({});

      expect(mockQualityAnalyzer.getDuplicationSummary).toHaveBeenCalledWith(
        expect.objectContaining({
          sortBy: 'duplicatedBlocks'
        }),
        undefined
      );
    });

    it('should handle custom maxResults', async () => {
      mockValidateInput.mockReturnValue({
        maxResults: 20
      });

      await handleGetDuplicationSummary({});

      expect(mockQualityAnalyzer.getDuplicationSummary).toHaveBeenCalledWith(
        expect.objectContaining({
          maxResults: 20
        }),
        undefined
      );
    });

    it('should handle custom pageSize', async () => {
      mockValidateInput.mockReturnValue({
        pageSize: 200
      });

      await handleGetDuplicationSummary({});

      expect(mockQualityAnalyzer.getDuplicationSummary).toHaveBeenCalledWith(
        expect.objectContaining({
          pageSize: 200
        }),
        undefined
      );
    });
  });

  describe('Error handling', () => {
    it('should handle validation errors gracefully', async () => {
      mockValidateInput.mockImplementation(() => {
        throw new Error('Invalid sort option');
      });

      const result = await handleGetDuplicationSummary({});

      expect(result.isError).toBe(true);
      expect(result.content[0].text).toContain('Error getting duplication summary');
      expect(result.content[0].text).toContain('Invalid sort option');
    });

    it('should handle analyzer errors gracefully', async () => {
      mockQualityAnalyzer.getDuplicationSummary = vi.fn(async () => {
        throw new Error('Failed to fetch duplication data');
      });

      const result = await handleGetDuplicationSummary({});

      expect(result.isError).toBe(true);
      expect(result.content[0].text).toContain('Error getting duplication summary');
      expect(result.content[0].text).toContain('Failed to fetch duplication data');
    });

    it('should handle errors without message', async () => {
      mockQualityAnalyzer.getDuplicationSummary = vi.fn(async () => {
        throw {};
      });

      const result = await handleGetDuplicationSummary({});

      expect(result.isError).toBe(true);
      expect(result.content[0].text).toContain('Error getting duplication summary');
    });

    it('should return error response instead of throwing', async () => {
      mockValidateInput.mockImplementation(() => {
        throw new Error('Validation failed');
      });

      // Should not throw, should return error response
      const result = await handleGetDuplicationSummary({});
      expect(result.isError).toBe(true);
    });
  });
});
