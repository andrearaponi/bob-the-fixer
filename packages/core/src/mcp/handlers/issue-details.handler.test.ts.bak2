import { describe, it, expect, vi, beforeEach } from 'vitest';
import { handleGetIssueDetails } from './issue-details.handler';

// Mock all dependencies
vi.mock('../../core/analysis/index.js');
vi.mock('../../universal/project-manager');
vi.mock('../../shared/validators/mcp-schemas');

describe('handleGetIssueDetails', () => {
  let mockIssueAnalyzer: any;
  let mockProjectManager: any;
  let mockValidateInput: any;

  beforeEach(async () => {
    // Mock validateInput
    const validators = await import('../../shared/validators/mcp-schemas');
    mockValidateInput = vi.mocked(validators.validateInput);
    mockValidateInput.mockReturnValue({
      issueKey: 'AX123',
      contextLines: 5,
      includeRuleDetails: true,
      includeCodeExamples: true,
      includeFilePath: true
    });

    // Mock ProjectManager
    const projectManagerModule = await import('../../universal/project-manager');
    mockProjectManager = {};
    vi.mocked(projectManagerModule.ProjectManager).mockImplementation(() => mockProjectManager);

    // Mock IssueAnalyzer
    const analysisModule = await import('../../core/analysis/index.js');
    mockIssueAnalyzer = {
      getIssueDetails: vi.fn(async () =>
        'ISSUE DETAILS\n\nKey: AX123\nSeverity: MAJOR\nType: BUG\n\nDescription: Null pointer exception'
      )
    };
    vi.mocked(analysisModule.IssueAnalyzer).mockImplementation(() => mockIssueAnalyzer);
  });

  describe('Success cases', () => {
    it('should validate input and call IssueAnalyzer', async () => {
      const args = {
        issueKey: 'AX123',
        contextLines: 5,
        includeRuleDetails: true,
        includeCodeExamples: true,
        includeFilePath: true
      };

      const result = await handleGetIssueDetails(args);

      expect(mockValidateInput).toHaveBeenCalledWith(
        expect.anything(),
        args,
        'sonar_get_issue_details'
      );
      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        {
          issueKey: 'AX123',
          contextLines: 5,
          includeRuleDetails: true,
          includeCodeExamples: true,
          includeFilePath: true
        },
        undefined
      );
      expect(result).toHaveProperty('content');
      expect(result.content[0].type).toBe('text');
    });

    it('should pass correlation ID through', async () => {
      const correlationId = 'test-corr-123';
      await handleGetIssueDetails({}, correlationId);

      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        expect.anything(),
        correlationId
      );
    });

    it('should return issue details report', async () => {
      const result = await handleGetIssueDetails({});

      expect(result.content[0].text).toContain('ISSUE DETAILS');
      expect(result.content[0].text).toContain('AX123');
    });

    it('should handle different context lines', async () => {
      mockValidateInput.mockReturnValue({
        issueKey: 'AX123',
        contextLines: 10
      });

      await handleGetIssueDetails({});

      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        expect.objectContaining({
          contextLines: 10
        }),
        undefined
      );
    });

    it('should handle includeRuleDetails false', async () => {
      mockValidateInput.mockReturnValue({
        issueKey: 'AX123',
        includeRuleDetails: false
      });

      await handleGetIssueDetails({});

      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        expect.objectContaining({
          includeRuleDetails: false
        }),
        undefined
      );
    });

    it('should handle includeCodeExamples false', async () => {
      mockValidateInput.mockReturnValue({
        issueKey: 'AX123',
        includeCodeExamples: false
      });

      await handleGetIssueDetails({});

      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        expect.objectContaining({
          includeCodeExamples: false
        }),
        undefined
      );
    });

    it('should handle includeFilePath false', async () => {
      mockValidateInput.mockReturnValue({
        issueKey: 'AX123',
        includeFilePath: false
      });

      await handleGetIssueDetails({});

      expect(mockIssueAnalyzer.getIssueDetails).toHaveBeenCalledWith(
        expect.objectContaining({
          includeFilePath: false
        }),
        undefined
      );
    });
  });

  describe('Error handling', () => {
    it('should propagate validation errors', async () => {
      mockValidateInput.mockImplementation(() => {
        throw new Error('Invalid issue key');
      });

      await expect(handleGetIssueDetails({})).rejects.toThrow('Invalid issue key');
    });

    it('should propagate analyzer errors', async () => {
      mockIssueAnalyzer.getIssueDetails = vi.fn(async () => {
        throw new Error('Issue not found');
      });

      await expect(handleGetIssueDetails({})).rejects.toThrow('Issue not found');
    });

    it('should propagate API errors', async () => {
      mockIssueAnalyzer.getIssueDetails = vi.fn(async () => {
        throw new Error('SonarQube API error');
      });

      await expect(handleGetIssueDetails({})).rejects.toThrow('SonarQube API error');
    });
  });
});
